<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order History - The Waiting Room Caf√©</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5dc;
      min-height: 100vh;
    }
    
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    h2 {
      color: #6d4c41;
      font-size: 2rem;
      margin-bottom: 30px;
      text-align: center;
    }
    
    #orderHistory {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 18px;
    }
    
    .order {
      background: #faf8f3;
      border-radius: 15px;
      padding: 18px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.08);
      transition: transform 0.3s, box-shadow 0.3s;
      border: 1px solid #d7ccc8;
      display: flex;
      flex-direction: column;
    }
    
    .order:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.12);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 2px solid #d7ccc8;
    }
    
    .order-header h4 {
      color: #6d4c41;
      font-size: 1.3rem;
      margin: 0;
    }
    
    .order-status {
      padding: 6px 15px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-confirmed {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .status-completed {
      background: #d4edda;
      color: #155724;
    }
    
    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }
    
    .order-details {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 12px;
      flex-grow: 1;
    }
    
    .order-preview {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .order-preview-image {
      width: 80px;
      min-width: 80px;
      height: 80px;
      border-radius: 12px;
      overflow: hidden;
      background: linear-gradient(135deg, #f5f5dc 0%, #e8dcc6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e0d2c3;
    }
    
    .order-preview-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .order-preview-placeholder {
      font-size: 1.8rem;
      color: rgba(109, 76, 65, 0.4);
    }
    
    .order-preview-info {
      flex: 1;
    }
    
    .order-detail-item {
      display: flex;
      flex-direction: column;
    }
    
    .order-detail-item label {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 3px;
    }
    
    .order-detail-item span {
      font-size: 1rem;
      font-weight: 600;
      color: #333;
    }
    
    .order-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 8px;
    }
    
    .image-unavailable {
      opacity: 0.5;
      filter: grayscale(70%);
    }
    
    .btn-view-details {
      background: linear-gradient(135deg, #6d4c41 0%, #8b6f47 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s, background 0.3s;
    }
    
    .btn-view-details:hover {
      transform: scale(1.05);
      background: linear-gradient(135deg, #8b6f47 0%, #a0826d 100%);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: #faf8f3;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.08);
      border: 1px solid #d7ccc8;
      grid-column: 1 / -1;
    }
    
    .empty-state h3 {
      color: #666;
      font-size: 1.5rem;
      margin-bottom: 10px;
    }
    
    .empty-state p {
      color: #999;
      margin-bottom: 20px;
    }
    
    .empty-state a {
      display: inline-block;
      background: linear-gradient(135deg, #6d4c41 0%, #8b6f47 100%);
      color: white;
      padding: 12px 30px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: transform 0.2s, background 0.3s;
    }
    
    .empty-state a:hover {
      transform: scale(1.05);
      background: linear-gradient(135deg, #8b6f47 0%, #a0826d 100%);
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      grid-column: 1 / -1;
    }
    
    @media (max-width: 768px) {
      #orderHistory {
        grid-template-columns: 1fr;
      }
    }
    
    @media (min-width: 769px) and (max-width: 1024px) {
      #orderHistory {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (min-width: 1025px) {
      #orderHistory {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .error-message {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid #c33;
      text-align: center;
      grid-column: 1 / -1;
    }
  </style>
</head>
<body>

  <div id="header-container"></div>

  <main>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
      <h2 style="margin: 0;">Your Order History</h2>
      <div class="currency" style="display: flex; align-items: center; gap: 10px;">
        <label for="currency" style="font-weight: 600; color: #6d4c41;">Currency:</label>
        <select id="currency" style="padding: 10px 15px; border: 2px solid #d7ccc8; border-radius: 8px; font-size: 1rem; background: white; cursor: pointer; transition: border-color 0.3s;">
          <option value="PHP">PHP</option>
          <option value="USD">USD</option>
          <option value="KRW">KRW</option>
        </select>
      </div>
    </div>
    <div id="orderHistory" class="loading">Loading orders...</div>
  </main>

  <script src="js/include.js"></script>
  <script>
    // Load header
    includeHTML('header-container', 'includes/header.html');
    
    // Get context path - same method as test-servlets.html
    // Set on window to avoid conflicts
    window.BASE_URL = window.location.origin + window.location.pathname.replace(/\/[^/]*$/, '');
    window.API_BASE = window.BASE_URL + '/api';
    const BASE_URL = window.BASE_URL;
    const API_BASE = window.API_BASE;
    
    console.log('Base URL:', BASE_URL);
    console.log('API Base:', API_BASE);
    
    let selectedCurrency = localStorage.getItem('selectedCurrency') || 'PHP';
    let currencies = [];
    const currencySelect = document.getElementById('currency');
    
    function resolveImageUrl(imageUrl) {
      if (!imageUrl) return null;
      let trimmed = String(imageUrl).trim();
      if (!trimmed) return null;
      if (/^(https?:|data:|blob:)/i.test(trimmed)) {
        return trimmed;
      }
      trimmed = trimmed.replace(/^\.\/+/, '');
      if (trimmed.startsWith('/')) {
        return trimmed;
      }
      if (trimmed.startsWith('assets/')) {
        return trimmed;
      }
      return `assets/images/${trimmed}`;
    }
    
    function escapeHTML(value) {
      if (value === undefined || value === null) return '';
      const str = String(value);
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
      return str.replace(/[&<>"']/g, (char) => map[char] || char);
    }
    
    function getOrderPreviewImage(order) {
      const resolvedSrc = resolveImageUrl(order.preview_image_url);
      if (resolvedSrc) {
        const alt = escapeHTML(order.preview_item_name || 'Menu item');
        return `<img src="${resolvedSrc}" alt="${alt}" loading="lazy" decoding="async">`;
      }
      return '<span class="order-preview-placeholder">üçΩÔ∏è</span>';
    }
    
    // Fetch currencies
    async function fetchCurrencies() {
      try {
        const response = await fetch(`${API_BASE}/menu/get_currencies`);
        const result = await response.json();
        
        if (result.success) {
          currencies = result.data;
          const storedCurrency = localStorage.getItem('selectedCurrency');
          selectedCurrency = storedCurrency || 'PHP';
          if (currencySelect) {
            currencySelect.value = selectedCurrency;
          }
        }
      } catch (error) {
        console.error('Error fetching currencies:', error);
      }
    }
    
    // Currency change handler
    if (currencySelect) {
      currencySelect.addEventListener('change', (e) => {
        selectedCurrency = e.target.value;
        localStorage.setItem('selectedCurrency', selectedCurrency);
        loadOrders();
      });
    }
    
    async function loadOrders() {
      try {
        const response = await fetch(`${API_BASE}/orders/get_orders`, {
          credentials: 'include'
        });
        const result = await response.json();
        const container = document.getElementById('orderHistory');
        
        if (result.success && result.data && result.data.length > 0) {
          // Get currency info
          const currency = currencies.find(c => c.code === selectedCurrency) || currencies.find(c => c.code === 'PHP') || { symbol: '‚Ç±', rate: 1 };
          const symbol = currency.symbol || '‚Ç±';
          const rate = currency.rate || 1;
          
          container.innerHTML = result.data.map(order => {
            const statusClass = `status-${order.status}`;
            const date = new Date(order.order_date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            const baseAmount = parseFloat(order.total_amount || 0);
            const totalAmount = baseAmount * rate;
            const previewImage = getOrderPreviewImage(order);
            const previewName = order.preview_item_name ? escapeHTML(order.preview_item_name) : 'Featured item';
            const numericPoints = Number(order.earned_points || 0);
            const hasLoyalty = !!order.loyalty_id;
            const pointsEarned = numericPoints > 0
              ? numericPoints
              : (hasLoyalty ? Math.max(0, Math.floor(baseAmount / 50)) : 0);
            
            return `
              <div class="order">
                <div class="order-header">
                  <h4>Order #${order.order_id}</h4>
                  <span class="order-status ${statusClass}">${order.status.toUpperCase()}</span>
                </div>
                <div class="order-preview">
                  <div class="order-preview-image">
                    ${previewImage}
                  </div>
                  <div class="order-preview-info">
                    <p style="margin: 0; color: #6d4c41; font-weight: 600;">${previewName}</p>
                    <p style="margin: 2px 0 0; color: #777; font-size: 0.85rem;">Tap to view full order</p>
                  </div>
                </div>
                <div class="order-details">
                  <div class="order-detail-item">
                    <label>Order Date</label>
                    <span>${date}</span>
                  </div>
                  <div class="order-detail-item">
                    <label>Total Amount</label>
                    <span>${symbol}${totalAmount.toFixed(2)}</span>
                  </div>
                  <div class="order-detail-item">
                    <label>Points Earned</label>
                    <span>${pointsEarned} points</span>
                  </div>
                </div>
                <div class="order-actions">
                  <button class="btn-view-details" onclick="viewOrderDetails(${order.order_id})">
                    View Details
                  </button>
                </div>
              </div>
            `;
          }).join('');
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <h3>No orders yet</h3>
              <p>Start shopping to see your order history here</p>
              <a href="products.html">Browse Menu</a>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('orderHistory').innerHTML = `
          <div class="error-message">
            Error loading orders. Please try again later.
          </div>
        `;
      }
    }
    
    function viewOrderDetails(orderId) {
      window.location.href = `order_details.html?order_id=${orderId}`;
    }
    
    fetchCurrencies().then(() => {
      loadOrders();
    });
  </script>
  
  <!-- Role-Based Access Control -->
  <script src="js/auth.js"></script>
  <script>
    // Apply access control: require customer login
    document.addEventListener('DOMContentLoaded', function() {
      applyPageAccessControl();
    });
  </script>

</body>
</html>

